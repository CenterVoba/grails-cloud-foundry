<html>
    <head>
        <meta http-equiv="Content-type" content="text/html; charset=utf-8"/>
        <title>7 Service Configuration</title>
        <link rel="stylesheet" href="../css/main.css" type="text/css" media="screen" title="Ref" charset="utf-8"/>
    </head>
    <body class="body">
    <h1><a name="7 Service Configuration">7 Service Configuration</a></h1>When you provision a service and bind it to an application, an environment variable <code>VCAP_SERVICES</code> is set for your server instance(s). This is a JSON string and you can use it to configure your DataSource, MongoDB, and Redis connections and will look something like this (formatted for readability):<p class="paragraph"/><div class="code"><pre>&#123;<span class="java&#45;quote">"redis&#45;2.2"</span>:
   &#91;&#123;<span class="java&#45;quote">"name"</span>:<span class="java&#45;quote">"redis&#45;1d8e28a"</span>,
     <span class="java&#45;quote">"label"</span>:<span class="java&#45;quote">"redis&#45;2.2"</span>,
     <span class="java&#45;quote">"plan"</span>:<span class="java&#45;quote">"free"</span>,
     <span class="java&#45;quote">"credentials"</span>:&#123;
         <span class="java&#45;quote">"node_id"</span>:<span class="java&#45;quote">"redis_node_3"</span>,
         <span class="java&#45;quote">"hostname"</span>:<span class="java&#45;quote">"172.30.48.42"</span>,
         <span class="java&#45;quote">"port"</span>:5004,
         <span class="java&#45;quote">"password"</span>:<span class="java&#45;quote">"1463d9d0&#45;4e35&#45;4f2e&#45;be2f&#45;01dc5536f183"</span>,
         <span class="java&#45;quote">"name"</span>:<span class="java&#45;quote">"redis&#45;1a69a915&#45;6522&#45;496c&#45;93d5&#45;1271d2b3118e"</span>&#125;
     &#125;&#93;,
 <span class="java&#45;quote">"mongodb&#45;1.8"</span>:
   &#91;&#123;<span class="java&#45;quote">"name"</span>:<span class="java&#45;quote">"mongodb&#45;3854dbe"</span>,
     <span class="java&#45;quote">"label"</span>:<span class="java&#45;quote">"mongodb&#45;1.8"</span>,
     <span class="java&#45;quote">"plan"</span>:<span class="java&#45;quote">"free"</span>,
     <span class="java&#45;quote">"credentials"</span>:&#123;
         <span class="java&#45;quote">"hostname"</span>:<span class="java&#45;quote">"172.30.48.63"</span>,
         <span class="java&#45;quote">"port"</span>:25003,
         <span class="java&#45;quote">"username"</span>:<span class="java&#45;quote">"b6877670&#45;da98&#45;4124&#45;85ca&#45;84357f042797"</span>,
         <span class="java&#45;quote">"password"</span>:<span class="java&#45;quote">"f53e6a4b&#45;f4b8&#45;497d&#45;ac81&#45;43cb22cf1e88"</span>,
         <span class="java&#45;quote">"name"</span>:<span class="java&#45;quote">"mongodb&#45;9dda2cfb&#45;9672&#45;4d58&#45;8786&#45;98c3abcb21ec"</span>,
         <span class="java&#45;quote">"db"</span>:<span class="java&#45;quote">"db"</span>&#125;
   &#125;&#93;,
 <span class="java&#45;quote">"mysql&#45;5.1"</span>:
   &#91;&#123;<span class="java&#45;quote">"name"</span>:<span class="java&#45;quote">"mysql&#45;497b12e"</span>,
     <span class="java&#45;quote">"label"</span>:<span class="java&#45;quote">"mysql&#45;5.1"</span>,
     <span class="java&#45;quote">"plan"</span>:<span class="java&#45;quote">"free"</span>,
     <span class="java&#45;quote">"credentials"</span>:&#123;
         <span class="java&#45;quote">"node_id"</span>:<span class="java&#45;quote">"mysql_node_8"</span>,
         <span class="java&#45;quote">"hostname"</span>:<span class="java&#45;quote">"172.30.48.27"</span>,
         <span class="java&#45;quote">"port"</span>:3306,
         <span class="java&#45;quote">"password"</span>:<span class="java&#45;quote">"p3rO5K5lRZaEU"</span>,
         <span class="java&#45;quote">"name"</span>:<span class="java&#45;quote">"d887d4f5664f64dde86f3ce42c6333962"</span>,
         <span class="java&#45;quote">"user"</span>:<span class="java&#45;quote">"umuPIJ8IzSKVA"</span>&#125;
     &#125;&#93;
&#125;</pre></div><p class="paragraph"/>Fortunately the plugin manages this for you, so in general you don't need to be aware of this. It will update your DataSource configuration if you have a MySQL service provisioned and bound, and likewise your MongoDB and Redis connection information if you have those plugins installed and have those services provisioned and bound.<p class="paragraph"/>If you're not using the MongoDB or Redis plugin then you'll need to access the information yourself - just call <code>System.getenv('VCAP_SERVICES')</code> and parse the JSON.<p class="paragraph"/><h4>DataSource</h4>
In addition to replacing the username, password, and JDBC url for your DataSource, the plugin will configure MySQL connection testing, using the following settings:<p class="paragraph"/><div class="code"><pre>removeAbandoned = <span class="java&#45;keyword">true</span>
removeAbandonedTimeout = 300 // 5 minutes
testOnBorrow = <span class="java&#45;keyword">true</span>
validationQuery = '/&#42; ping &#42;/ SELECT 1'</pre></div><p class="paragraph"/>This will only be done if the DataSource is the standard <code>org.apache.commons.dbcp.BasicDataSource</code> that Grails configures since we assume that if you have customized the DataSource, you will configure connection testing yourself. You can also tell the plugin to not make these changes with<p class="paragraph"/><div class="code"><pre>grails.plugin.cloudfoundry.datasource.disableTimeoutAutoconfiguration = <span class="java&#45;keyword">true</span></pre></div><p class="paragraph"/>in <code>Config.groovy</code>.<p class="paragraph"/>You should specify the <code>Dialect</code> to ensure that the correct table type is used. InnoDB tables are preferred since MyISAM tables do not support transactions, so it's a good idea to use the <code>MySQLInnoDBDialect</code>. In addition you can customize the JDBC url (for example to use UTF-8). The best way to configure these is to populate the <code>production</code> settings (or whichever environment you're using for deployment) with these values, for example:<p class="paragraph"/><div class="code"><pre>production &#123;
   dataSource &#123;
      dialect = org.hibernate.dialect.MySQLInnoDBDialect
      driverClassName = 'com.mysql.jdbc.Driver'
      username = 'n/a'
      password = 'n/a'
      url = 'jdbc:mysql://localhost/db?useUnicode=<span class="java&#45;keyword">true</span>&#38;characterEncoding=utf8'
      dbCreate = 'update'
   &#125;
&#125;</pre></div><p class="paragraph"/><code>username</code> and <code>password</code> will be replaced but can't be blank or missing, so they're set to dummy values. In addition the part of the URL to the left of the ? character will be replaced, so that just has to be valid syntax but doesn't need to be a real database. The part to the right of the ? (<code>"useUnicode=true&#38;characterEncoding=utf8"</code>) will be appended to the auto-generated URL.<p class="paragraph"/><h4>Searchable</h4><p class="paragraph"/>Although there's no explicit support for Compass in Cloud Foundry, the plugin does detect that the Searchable plugin is installed and will configure it to write its Lucene index to a writeable directory on your server.

    
<script type="text/javascript">
	var _gaq = _gaq || [];
	_gaq.push(['_setAccount', 'UA-16219500-1']);
	_gaq.push(['_trackPageview']);

	(function() {
		var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
		ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
		var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
	})();
</script>
</body>
</html>
